<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="de">
<head>
    <meta charset="UTF-8">
    <title>RBS' Estimation Poker</title>
    <link rel="icon" href="https://noxvobiscum.at/wp-content/uploads/2022/09/cropped-nvb-favicon-32x32.png" sizes="32x32" />
    <link rel="stylesheet" th:href="@{/styles.css}">
</head>
<body>

<div class="container">
    <h1>üÉè RBS' Estimation Poker</h1>

    <!-- Fehleranzeige: nimmt error entweder aus Model ODER aus Query-Param an -->
    <div th:if="${error != null or param.error != null}"
         class="error"
         th:text="${error != null ? error : param.error}">Fehlermeldung</div>

    <form th:action="@{/join}" method="post" id="joinForm" class="join-form">
        <div class="form-row">
            <div class="form-field">
                <label for="participantName">Dein Name</label>
                <input type="text"
                       id="participantName"
                       name="participantName"
                       placeholder="z. B. Julia"
                       th:value="${param.participantName} ?: ${participantName}"
                       required>
            </div>

            <div class="form-field">
                <label for="roomCode">Raumcode / Name</label>
                <div style="display:grid; gap:6px;">
                    <input type="text"
                           id="roomCode"
                           name="roomCode"
                           placeholder="z. B. Team-Sprint-42"
                           th:value="${param.roomCode} ?: ${roomCode}"
                           required>
                    <!-- Live-Status f√ºr Namensverf√ºgbarkeit -->
                    <div id="nameCheck" class="hint" aria-live="polite"></div>
                </div>
            </div>
        </div>

        <!-- Persistenter Raum -->
        <div class="checkbox-row">
            <input type="checkbox"
                   id="persistent"
                   name="persistent"
                   th:checked="${(param.persistent != null) or (persistent == true)}">
            <label for="persistent">Diesen Raum dauerhaft speichern</label>
        </div>
        <p class="hint">
            Erzeugt einen Deep-Link (<code>/room/{ID}</code>). Der Raum bleibt bestehen,
            bis der Auto-Cleanup greift.
        </p>

        <!-- Test-Raum (nur sichtbar bei persistent) -->
        <div id="testRoomWrap" class="checkbox-row hidden">
            <input type="checkbox"
                   id="testRoom"
                   name="testRoom"
                   th:checked="${(param.testRoom != null) or (testRoom == true)}">
            <label for="testRoom">Nur Test-Raum</label>
        </div>
        <p id="testRoomHint" class="hint hidden">
            Markiert den Raum als Test ‚Äì wird schneller automatisch gel√∂scht (z. B. nach 7 Tagen).
        </p>

        <div class="form-actions">
            <button type="submit" class="button">Beitreten</button>
        </div>
    </form>
</div>

<!-- JS: testRoom-Checkbox nur zeigen, wenn persistent aktiv + Live-Name-Check + Button-Disable -->
<script th:inline="javascript">
    (function () {
        const persistent = document.getElementById('persistent');
        const testWrap = document.getElementById('testRoomWrap');
        const testHint = document.getElementById('testRoomHint');
        const testRoom = document.getElementById('testRoom');
        const roomCodeEl = document.getElementById('roomCode');
        const participantEl = document.getElementById('participantName');
        const nameCheck = document.getElementById('nameCheck');
        const joinButton = document.querySelector('#joinForm button[type="submit"]');

        let nameTaken = false; // globaler Zustand f√ºr Button-Enable-Logik

        function syncTestVisibility() {
            const show = persistent.checked;
            testWrap.classList.toggle('hidden', !show);
            testHint.classList.toggle('hidden', !show);
            // Beim Ausblenden Haken entfernen
            if (!show && testRoom) testRoom.checked = false;

            // Wenn persistent aus -> Statusmeldung leeren + Button pr√ºfen
            if (!show) {
                setStatusEmpty();
            }
            updateSubmitEnabled();
        }

        function isEmpty(s) {
            return !s || s.trim().length === 0;
        }

        function updateSubmitEnabled() {
            const pnEmpty = isEmpty(participantEl.value);
            const rcEmpty = isEmpty(roomCodeEl.value);

            // Regeln:
            // - Felder d√ºrfen nicht leer sein
            // - Wenn persistent aktiv, darf Name NICHT 'taken' sein
            let disabled = pnEmpty || rcEmpty;
            if (persistent.checked && nameTaken) disabled = true;

            if (joinButton) joinButton.disabled = disabled;
        }

        // Debounce + Abort f√ºr fetch
        let debounceTimer = null;
        let currentAbort = null;

        function setStatusLoading() {
            nameCheck.textContent = "Pr√ºfe Verf√ºgbarkeit‚Ä¶";
            nameCheck.classList.remove("ok","bad");
            nameCheck.classList.add("loading");
            nameTaken = false; // unentschieden -> nicht blockieren
            updateSubmitEnabled();
        }
        function setStatusOK() {
            nameCheck.textContent = "‚úÖ Name ist frei";
            nameCheck.classList.remove("bad","loading");
            nameCheck.classList.add("ok");
            nameTaken = false;
            updateSubmitEnabled();
        }
        function setStatusBad() {
            nameCheck.textContent = "‚ùå Name ist vergeben";
            nameCheck.classList.remove("ok","loading");
            nameCheck.classList.add("bad");
            nameTaken = true;
            updateSubmitEnabled();
        }
        function setStatusEmpty() {
            nameCheck.textContent = "";
            nameCheck.classList.remove("ok","bad","loading");
            nameTaken = false;
            updateSubmitEnabled();
        }

        async function checkNameAvailability(name) {
            // Nur pr√ºfen, wenn persistent aktiv ist
            if (!persistent.checked) {
                setStatusEmpty();
                return;
            }
            const trimmed = (name || "").trim();
            if (trimmed.length === 0) {
                setStatusEmpty();
                return;
            }

            // Abbrechen, falls vorheriger Request noch l√§uft
            if (currentAbort) currentAbort.abort();
            currentAbort = new AbortController();
            const { signal } = currentAbort;

            setStatusLoading();
            try {
                const resp = await fetch(`/api/rooms/check?name=` + encodeURIComponent(trimmed), { signal });
                if (!resp.ok) throw new Error("Bad response: " + resp.status);
                const taken = await resp.json(); // boolean
                if (signal.aborted) return; // Zwischenzeitlich √ºberholt

                if (taken === true) setStatusBad();
                else setStatusOK();
            } catch (e) {
                if (signal.aborted) return;
                // Im Fehlerfall lieber neutral bleiben (Button nur nach Feldpr√ºfungen)
                setStatusEmpty();
                console.warn("Name check failed:", e);
            }
        }

        function scheduleCheck() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => checkNameAvailability(roomCodeEl.value), 250);
        }

        // Initial bei Page-Load (damit Zustand bei Back/Reload stimmt)
        syncTestVisibility();
        if (persistent.checked) {
            scheduleCheck(); // falls Werte aus Parametern kommen, gleich pr√ºfen
        }

        // Events
        persistent.addEventListener('change', () => {
            syncTestVisibility();
            if (persistent.checked) scheduleCheck(); else setStatusEmpty();
        });
        roomCodeEl.addEventListener('input', () => { scheduleCheck(); updateSubmitEnabled(); });
        participantEl.addEventListener('input', updateSubmitEnabled);

        // Initiale Button-Logik
        updateSubmitEnabled();
    })();

// Enter-Handling mit Shake-Animation am Button
const joinForm = document.getElementById('joinForm');
const joinButton = joinForm.querySelector('button[type="submit"]');

joinForm.addEventListener('keydown', function (event) {
    if (event.key === 'Enter') {
        const name = document.getElementById('participantName').value.trim();
        const room = document.getElementById('roomCode').value.trim();
        const isPersistent = document.getElementById('persistent').checked;
        const nameStatusBad = document.getElementById('nameCheck').classList.contains('bad');

        // Bedingungen f√ºr "nicht submittable"
        if (!name || !room || (isPersistent && nameStatusBad)) {
            event.preventDefault(); // Verhindert das Absenden
            // Shake-Animation triggern
            joinButton.classList.add('shake');
            setTimeout(() => joinButton.classList.remove('shake'), 400);
        }
    }
});
    
</script>

<!-- Minimaler Fallback-Stil, falls styles.css nichts dazu hat -->
<style>
    .join-form { display: grid; gap: 16px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .form-field label { display: block; margin-bottom: 6px; }
    .form-field input[type="text"] { width: 100%; }
    .checkbox-row { display: flex; align-items: center; gap: 10px; }
    .form-actions { margin-top: 8px; }
    .hint { margin: -6px 0 8px 0; opacity: .85; font-size: .9em; }
    .hidden { display: none; }
    #nameCheck.ok { color: #22c55e; }       /* gr√ºn */
    #nameCheck.bad { color: #ef4444; }      /* rot */
    #nameCheck.loading { color: #a3a3a3; }  /* grau */
    .button:disabled { opacity: .6; cursor: not-allowed; }
</style>

</body>
</html>
