<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:lang="${#locale}" lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="dark light">
  <title th:text="#{app.title}">RBS' Estimation Poker</title>
  <link rel="icon" href="https://noxvobiscum.at/wp-content/uploads/2022/09/cropped-nvb-favicon-32x32.png" sizes="32x32" />
  <!-- Early theme apply (prevents flash) -->
  <script>
    (function(){
      try {
        var t = localStorage.getItem('estpoker-theme') || 'dark';
        if (t === 'system') document.documentElement.removeAttribute('data-theme');
        else document.documentElement.setAttribute('data-theme', t);
      } catch(e){}
    })();
  </script>
  <link rel="stylesheet" th:href="@{/styles.css}">
</head>
<body>
<!-- Hamburger (morphs to âœ• when open) -->
<button id="menuButton" class="menu-button" aria-expanded="false" aria-controls="appMenuOverlay" aria-label="Open menu">â˜°</button>

<!-- Overlay Menu -->
<div id="appMenuOverlay" class="menu-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="menuTitle">
  <div class="menu-backdrop" data-close></div>
  <div class="menu-panel">
    <div class="menu-header">
      <h3 id="menuTitle" th:text="#{menu.title}">Menu</h3>
      <!-- Using morph pattern: no separate close button needed -->
    </div>

    <div class="menu-section">
      <!-- Language -->
      <button id="langRow" class="menu-item" type="button" aria-label="Switch language">
        <span class="mi-icon">
          <span class="flag-split" aria-hidden="true">
            <img class="flag flag-a" src="/flags/us.svg" alt="">
            <img class="flag flag-b" src="/flags/gb.svg" alt="">
          </span>
        </span>
        <span><span th:text="#{menu.language}">Language</span>: <strong id="langCurrent">English</strong></span>
      </button>

      <!-- Theme -->
      <div class="menu-group">
        <div class="group-title" th:text="#{menu.theme}">Theme</div>
        <div class="menu-choice">
          <button id="themeLight"  class="choice-btn" type="button"><span class="mi-icon" aria-hidden="true">ğŸŒ</span><span th:text="#{theme.light}">Light</span></button>
          <button id="themeDark"   class="choice-btn" type="button"><span class="mi-icon" aria-hidden="true">ğŸŒ™</span><span th:text="#{theme.dark}">Dark</span></button>
          <button id="themeSystem" class="choice-btn" type="button"><span class="mi-icon" aria-hidden="true">ğŸ–¥ï¸</span><span th:text="#{theme.system}">System</span></button>
        </div>
      </div>
    </div>
  </div>
</div>

<h1 th:text="#{ui.heading}">ğŸƒ RBS' Estimation Poker</h1>

<!-- Error message -->
<div th:if="${error != null or param.error != null}" class="error"
     th:text="${error != null ? error : param.error}">Error</div>

<div class="container landing-container">
  <form th:action="@{/join}" method="post" id="joinForm" class="join-form">
    <div class="form-row">
      <div class="form-field">
        <label for="participantName" th:text="#{label.yourName}">Your name</label>
        <input type="text" id="participantName" name="participantName"
               th:value="${param.participantName != null ? param.participantName : participantName}">
      </div>

      <div class="form-field">
        <label for="roomCode" th:text="#{label.roomCode}">Room code / name</label>
        <div style="display:grid; gap:6px;">
          <input type="text" id="roomCode" name="roomCode"
                 th:value="${param.roomCode != null ? param.roomCode : roomCode}">
          <div id="nameCheck" class="hint" aria-live="polite"></div>
        </div>
      </div>
    </div>

    <!-- Persist UI only when feature is enabled -->
    <div th:if="${@environment.getProperty('features.persistentRooms.enabled','false') == 'true'}">
      <div class="checkbox-row">
        <input type="checkbox" id="persistent" name="persistent"
               th:checked="${(param.persistent != null) or (persistent == true)}">
        <label for="persistent" th:text="#{label.persistRoom}">Persist this room</label>
      </div>
      <p class="hint" th:utext="#{hint.persistExpl}">
        Creates a deep link (<code>/room/{ID}</code>). The room persists until auto-cleanup.
      </p>

      <div id="testRoomWrap" class="checkbox-row hidden">
        <input type="checkbox" id="testRoom" name="testRoom"
               th:checked="${(param.testRoom != null) or (testRoom == true)}">
        <label for="testRoom" th:text="#{label.testRoom}">Test room only</label>
      </div>
      <p id="testRoomHint" class="hint hidden" th:text="#{hint.testRoom}">
        Marks as test â€“ will be cleaned up sooner.
      </p>
    </div>

    <!-- Hint when feature is off -->
    <p class="hint"
       th:if="${@environment.getProperty('features.persistentRooms.enabled','false') != 'true'}">
      Persistent rooms are not available on this deployment.
    </p>

    <div class="form-actions">
      <button type="submit" class="button" th:text="#{button.join}">Join</button>
    </div>
  </form>
</div>

<script>
/* ===== Menu open/close (morph â˜° â‡„ âœ•) ===== */
(function(){
  const btn = document.getElementById('menuButton');
  const overlay = document.getElementById('appMenuOverlay');
  const backdrop = overlay?.querySelector('[data-close]');

  function openMenu(){
    document.body.classList.add('menu-open');
    overlay.classList.remove('hidden');
    btn.classList.add('open');
    btn.setAttribute('aria-expanded','true');
    btn.setAttribute('aria-label','Close menu');
    btn.textContent = 'âœ•';
  }
  function closeMenu(){
    document.body.classList.remove('menu-open');
    overlay.classList.add('hidden');
    btn.classList.remove('open');
    btn.setAttribute('aria-expanded','false');
    btn.setAttribute('aria-label','Open menu');
    btn.textContent = 'â˜°';
  }
  function toggleMenu(){ overlay.classList.contains('hidden') ? openMenu() : closeMenu(); }

  btn?.addEventListener('click', toggleMenu);
  backdrop?.addEventListener('click', closeMenu);
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeMenu(); });
})();

/* ===== Theme handling (light/dark/system) ===== */
(function(){
  const bLight  = document.getElementById('themeLight');
  const bDark   = document.getElementById('themeDark');
  const bSystem = document.getElementById('themeSystem');

  function currentTheme(){
    const attr = document.documentElement.getAttribute('data-theme');
    if (attr) return attr; // 'light' or 'dark'
    try { return matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark'; }
    catch(e){ return 'dark'; }
  }
  function applyTheme(t){
    if (t === 'system') document.documentElement.removeAttribute('data-theme');
    else document.documentElement.setAttribute('data-theme', t);
    try { localStorage.setItem('estpoker-theme', t); } catch(e){}
    setActive(t === 'system' ? 'system' : (t==='light'?'light':'dark'));
  }
  function setActive(key){
    [bLight,bDark,bSystem].forEach(btn=>btn && btn.classList.remove('active'));
    ({light:bLight, dark:bDark, system:bSystem}[key])?.classList.add('active');
  }

  document.addEventListener('DOMContentLoaded', function(){
    const saved = localStorage.getItem('estpoker-theme') || 'dark';
    setActive(saved==='system' ? 'system' : saved);
    bLight?.addEventListener('click', ()=>applyTheme('light'));
    bDark?.addEventListener('click',  ()=>applyTheme('dark'));
    bSystem?.addEventListener('click',()=>applyTheme('system'));
  });
})();

/* ===== Language switch (EN/DE) ===== */
(function(){
  const langRow = document.getElementById('langRow');
  const cur = (document.documentElement.lang || 'en').toLowerCase();
  const a = langRow?.querySelector('.flag-a');
  const b = langRow?.querySelector('.flag-b');
  const label = document.getElementById('langCurrent');

  function setSplit(lang){
    if (!a || !b) return;
    if (String(lang).startsWith('de')) { a.src='/flags/de.svg'; b.src='/flags/at.svg'; label && (label.textContent='Deutsch'); }
    else { a.src='/flags/us.svg'; b.src='/flags/gb.svg'; label && (label.textContent='English'); }
  }
  function nextLang(){ return cur.startsWith('de') ? 'en' : 'de'; }
  function switchLang(to){
    const url = new URL(window.location.href);
    url.searchParams.set('lang', to);
    window.location.replace(url.toString()); // GET â†’ avoids 405
  }

  document.addEventListener('DOMContentLoaded', function(){
    setSplit(cur);
    langRow?.addEventListener('click', function(){
      const to = nextLang();
      setSplit(to);
      switchLang(to);
    });
  });
})();

/* ===== Landing page form JS (same as before; safe if persist UI absent) ===== */
(function () {
  const persistent = document.getElementById('persistent'); // may be null
  const testWrap   = document.getElementById('testRoomWrap'); // may be null
  const testHint   = document.getElementById('testRoomHint'); // may be null
  const testRoom   = document.getElementById('testRoom');     // may be null
  const roomCodeEl = document.getElementById('roomCode');
  const participantEl = document.getElementById('participantName');
  const nameCheck  = document.getElementById('nameCheck');
  const joinButton = document.querySelector('#joinForm button[type="submit"]');
  const joinForm   = document.getElementById('joinForm');

  let nameTaken = false;

  const MSG_CHECKING = /*[[#{status.checking}]]*/ 'Checking availabilityâ€¦';
  const MSG_FREE     = /*[[#{status.free}]]*/ 'âœ… Name is available';
  const MSG_TAKEN    = /*[[#{status.taken}]]*/ 'âŒ Name is taken';

  function isEmpty(s){ return !s || s.trim().length===0; }
  function persistEnabled(){ return !!persistent; }
  function isPersistChecked(){ return persistent && persistent.checked; }

  function isSubmittable(){
    if (isEmpty(participantEl.value) || isEmpty(roomCodeEl.value)) return false;
    if (isPersistChecked() && nameTaken) return false;
    return true;
  }
  function updateSubmitEnabled(){ joinButton.disabled=!isSubmittable(); }

  function setStatusLoading(){ nameCheck.textContent=MSG_CHECKING; nameCheck.className="hint loading"; nameTaken=false; updateSubmitEnabled(); }
  function setStatusOK(){ nameCheck.textContent=MSG_FREE; nameCheck.className="hint ok"; nameTaken=false; updateSubmitEnabled(); }
  function setStatusBad(){ nameCheck.textContent=MSG_TAKEN; nameCheck.className="hint bad"; nameTaken=true; updateSubmitEnabled(); }
  function setStatusEmpty(){ nameCheck.textContent=""; nameCheck.className="hint"; nameTaken=false; updateSubmitEnabled(); }

  function syncTestVisibility(){
    if (!persistEnabled()) return;
    const show = isPersistChecked();
    if (testWrap) testWrap.classList.toggle('hidden', !show);
    if (testHint) testHint.classList.toggle('hidden', !show);
    if (!show && testRoom) testRoom.checked = false;
    if (!show) setStatusEmpty();
    updateSubmitEnabled();
  }

  let debounceTimer=null, currentAbort=null;

  async function checkNameAvailability(name){
    if (!isPersistChecked()) { setStatusEmpty(); return; }
    const trimmed=(name||"").trim(); if (trimmed.length===0){ setStatusEmpty(); return; }

    if (currentAbort) currentAbort.abort();
    currentAbort=new AbortController(); const {signal}=currentAbort;

    setStatusLoading();
    try{
      const resp=await fetch(`/api/rooms/check?name=`+encodeURIComponent(trimmed),{signal});
      if(!resp.ok) throw new Error("Bad response: "+resp.status);
      const taken=await resp.json(); if(signal.aborted) return;
      if(taken===true) setStatusBad(); else setStatusOK();
    }catch(e){
      if (signal.aborted) return;
      setStatusEmpty();
      console.warn("Name check failed:", e);
    }
  }
  function scheduleCheck(){ clearTimeout(debounceTimer); debounceTimer=setTimeout(()=>checkNameAvailability(roomCodeEl.value),250); }

  joinForm.addEventListener('submit', function (event) {
    if (!isSubmittable()) { event.preventDefault(); joinButton.classList.add('shake'); setTimeout(()=>joinButton.classList.remove('shake'),400); }
  });

  if (persistEnabled()) {
    syncTestVisibility();
    if (isPersistChecked()) scheduleCheck();
    persistent.addEventListener('change', ()=>{ syncTestVisibility(); if (isPersistChecked()) scheduleCheck(); else setStatusEmpty(); });
  }
  roomCodeEl.addEventListener('input', ()=>{ if (isPersistChecked()) scheduleCheck(); updateSubmitEnabled(); });
  participantEl.addEventListener('input', updateSubmitEnabled);
  updateSubmitEnabled();
})();
</script>
</body>
</html>
