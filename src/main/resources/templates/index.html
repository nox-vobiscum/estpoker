<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:lang="${#locale}" lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="dark light">
  <title th:text="#{app.title}">RBS' Estimation Poker</title>

  <!-- Favicons -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="alternate icon" href="/favicon.ico" sizes="any">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">

  <!-- Early theme apply (prevents flash) -->
  <script>
    (function(){try{
      var t=localStorage.getItem('estpoker-theme')||'dark';
      if(t==='system')document.documentElement.removeAttribute('data-theme');
      else document.documentElement.setAttribute('data-theme',t);
    }catch(e){}})();
  </script>

  <link rel="stylesheet" th:href="@{/styles.css}">
</head>
<body>
<!-- Hamburger (morphs to ‚úï when open) -->
<button id="menuButton" class="menu-button" aria-expanded="false" aria-controls="appMenuOverlay" aria-label="Open menu">‚ò∞</button>

<!-- Overlay Menu -->
<div id="appMenuOverlay" class="menu-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="menuTitle">
  <div class="menu-backdrop" data-close></div>
  <div class="menu-panel">
    <div class="menu-header">
      <h3 id="menuTitle" th:text="#{menu.title}">Settings</h3>
    </div>

    <div class="menu-section">
      <!-- Language -->
      <button id="langRow" class="menu-item" type="button" aria-label="Switch language">
        <span class="mi-icon">
          <span class="flag-split" aria-hidden="true">
            <img class="flag flag-a" src="/flags/us.svg" alt="">
            <img class="flag flag-b" src="/flags/gb.svg" alt="">
          </span>
        </span>
        <span><span th:text="#{menu.language}">Language</span>: <strong id="langCurrent">English</strong></span>
      </button>

      <!-- Theme -->
      <div class="menu-group">
        <div class="group-title" th:text="#{menu.theme}">Theme</div>
        <div class="menu-choice">
          <button id="themeLight"  class="choice-btn" type="button"><span class="mi-icon" aria-hidden="true">üåû</span><span th:text="#{theme.light}">Light</span></button>
          <button id="themeDark"   class="choice-btn" type="button"><span class="mi-icon" aria-hidden="true">üåô</span><span th:text="#{theme.dark}">Dark</span></button>
          <button id="themeSystem" class="choice-btn" type="button"><span class="mi-icon" aria-hidden="true">üñ•Ô∏è</span><span th:text="#{theme.system}">System</span></button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container landing-container">
  <h1 class="app-title">
    <img src="/favicon.svg" alt="" width="24" height="24" class="logo">
    <span th:text="#{ui.heading}">RBS' Estimation Poker</span>
  </h1>

  <!-- Error message -->
  <div th:if="${error != null or param.error != null}" class="error"
       th:text="${error != null ? error : param.error}">Error</div>

  <!-- Join form (ohne Persist-Option) -->
  <form th:action="@{/join}" method="post" id="joinForm" class="join-form">
    <div class="form-row">
      <div class="form-field">
        <label for="participantName" th:text="#{label.yourName}">Your name</label>
        <input type="text" id="participantName" name="participantName"
               th:value="${param.participantName != null ? param.participantName : participantName}">
      </div>

      <div class="form-field">
        <label for="roomCode" th:text="#{label.roomCode}">Room code / name</label>
        <input type="text" id="roomCode" name="roomCode"
               th:value="${param.roomCode != null ? param.roomCode : roomCode}">
      </div>
    </div>

    <div class="form-actions">
      <button type="submit" class="button" th:text="#{button.join}">Join</button>
    </div>
  </form>
</div>

<script>
/* ===== Menu open/close (morph ‚ò∞ ‚áÑ ‚úï) + Focus Trap ===== */
(function(){
  const btn = document.getElementById('menuButton');
  const overlay = document.getElementById('appMenuOverlay');
  const panel = overlay?.querySelector('.menu-panel');
  const backdrop = overlay?.querySelector('[data-close]');
  let lastFocus = null;

  function focusables(){
    return panel.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
  }
  function trapTab(e){
    if (e.key !== 'Tab' || overlay.classList.contains('hidden')) return;
    const f = focusables(); if (!f.length) return;
    const first = f[0], last = f[f.length-1];
    if (e.shiftKey && document.activeElement === first) { last.focus(); e.preventDefault(); }
    else if (!e.shiftKey && document.activeElement === last) { first.focus(); e.preventDefault(); }
  }

  function openMenu(){
    document.body.classList.add('menu-open');
    overlay.classList.remove('hidden');
    btn.classList.add('open');
    btn.setAttribute('aria-expanded','true');
    btn.setAttribute('aria-label','Close menu');
    btn.textContent = '‚úï';
    lastFocus = document.activeElement;
    setTimeout(()=>focusables()[0]?.focus(), 0);
    window.addEventListener('keydown', trapTab);
  }
  function closeMenu(){
    document.body.classList.remove('menu-open');
    overlay.classList.add('hidden');
    btn.classList.remove('open');
    btn.setAttribute('aria-expanded','false');
    btn.setAttribute('aria-label','Open menu');
    btn.textContent = '‚ò∞';
    window.removeEventListener('keydown', trapTab);
    lastFocus?.focus();
  }
  function toggleMenu(){ overlay.classList.contains('hidden') ? openMenu() : closeMenu(); }

  btn?.addEventListener('click', toggleMenu);
  backdrop?.addEventListener('click', closeMenu);
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeMenu(); });
})();

/* ===== Theme handling (light/dark/system) ===== */
(function(){
  const bLight  = document.getElementById('themeLight');
  const bDark   = document.getElementById('themeDark');
  const bSystem = document.getElementById('themeSystem');

  function applyTheme(t){
    if (t === 'system') document.documentElement.removeAttribute('data-theme');
    else document.documentElement.setAttribute('data-theme', t);
    try { localStorage.setItem('estpoker-theme', t); } catch(e){}
    [bLight,bDark,bSystem].forEach(x=>x&&x.classList.remove('active'));
    ({light:bLight, dark:bDark, system:bSystem}[t||'dark'])?.classList.add('active');
  }

  document.addEventListener('DOMContentLoaded', function(){
    const saved = localStorage.getItem('estpoker-theme') || 'dark';
    ({light:bLight, dark:bDark, system:bSystem}[saved])?.classList.add('active');
    bLight?.addEventListener('click', ()=>applyTheme('light'));
    bDark?.addEventListener('click',  ()=>applyTheme('dark'));
    bSystem?.addEventListener('click',()=>applyTheme('system'));
  });
})();

/* ===== Language: POST /i18n, dann reload ===== */
(function(){
  const row   = document.getElementById('langRow');
  const cur   = (document.documentElement.lang || 'en').toLowerCase();
  const a     = row?.querySelector('.flag-a');
  const b     = row?.querySelector('.flag-b');
  const label = document.getElementById('langCurrent');

  function setSplit(lang){
    if (!a || !b) return;
    if (String(lang).startsWith('de')) { a.src='/flags/de.svg'; b.src='/flags/at.svg'; if (label) label.textContent='Deutsch'; }
    else { a.src='/flags/us.svg'; b.src='/flags/gb.svg'; if (label) label.textContent='English'; }
  }
  function nextLang(){ return cur.startsWith('de') ? 'en' : 'de'; }

  function switchLang(to){
    fetch('/i18n', {
      method:'POST',
      headers:{'Content-Type':'application/x-www-form-urlencoded'},
      body:'lang='+encodeURIComponent(to)
    }).finally(()=>location.reload());
  }

  document.addEventListener('DOMContentLoaded', function(){
    setSplit(cur);
    row?.addEventListener('click', function(){
      const to = nextLang();
      setSplit(to);
      switchLang(to);
    });
  });
})();
</script>

<!-- Kick/redirect toast relay (optional, harmless) -->
<script>
  (function(){
    try{
      const msg = localStorage.getItem('ep-toast');
      if (msg) {
        localStorage.removeItem('ep-toast');
        const t=document.createElement('div');
        t.className='toast'; t.textContent=msg;
        document.body.appendChild(t);
        setTimeout(()=>t.remove(), 3000);
      }
    }catch(e){}
  })();
</script>
</body>
</html>
