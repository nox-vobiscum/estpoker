<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:lang="${#locale}" lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="dark light">
  <title th:text="#{app.title}">RBS' Estimation Poker</title>
  <link rel="icon" href="https://noxvobiscum.at/wp-content/uploads/2022/09/cropped-nvb-favicon-32x32.png" sizes="32x32" />
  <!-- Early theme apply -->
  <script>
    (function(){try{
      var t=localStorage.getItem('estpoker-theme')||'dark';
      if(t==='system')document.documentElement.removeAttribute('data-theme');
      else document.documentElement.setAttribute('data-theme',t);
    }catch(e){}})();
  </script>
  <link rel="stylesheet" th:href="@{/styles.css}">
</head>
<body>
<script>
  // ===== THEME (light/dark/system) =====
  (function(){
    function currentTheme(){
      const a=document.documentElement.getAttribute('data-theme');
      if(a) return a; // light|dark explicitly set
      try{ return matchMedia('(prefers-color-scheme: light)').matches?'light':'dark'; }catch(e){ return 'dark'; }
    }
    function setTheme(t){
      if(t==='system') document.documentElement.removeAttribute('data-theme');
      else document.documentElement.setAttribute('data-theme',t);
      try{ localStorage.setItem('estpoker-theme',t);}catch(e){}
      updateThemeButtons(t==='system'? 'system' : t);
    }
    function updateThemeButtons(active){
      const ids=['themeLight','themeDark','themeSystem'];
      ids.forEach(id=>{
        const btn=document.getElementById(id);
        if(!btn) return;
        const isActive=(id==='themeLight'&&active==='light')||(id==='themeDark'&&active==='dark')||(id==='themeSystem'&&active==='system');
        btn.classList.toggle('active', isActive);
        btn.setAttribute('aria-pressed', String(isActive));
      });
    }
    document.addEventListener('DOMContentLoaded', function(){
      const saved = localStorage.getItem('estpoker-theme') || 'dark'; // default dark if never set
      const effective = (saved==='system') ? currentTheme() : saved;
      updateThemeButtons(saved==='system' ? 'system' : saved);

      const bLight = document.getElementById('themeLight');
      const bDark  = document.getElementById('themeDark');
      const bSys   = document.getElementById('themeSystem');
      if(bLight) bLight.addEventListener('click', ()=>setTheme('light'));
      if(bDark)  bDark.addEventListener('click', ()=>setTheme('dark'));
      if(bSys)   bSys.addEventListener('click', ()=>setTheme('system'));
    });
  })();

  // ===== LANGUAGE TOGGLE (flags + ?lang=‚Ä¶) =====
  (function(){
    function nextLang(){ const cur=(document.documentElement.lang||'en').toLowerCase(); return cur.startsWith('de')?'en':'de'; }
    function setSplit(lang){
      const a=document.querySelector('#langToggle .flag-a');
      const b=document.querySelector('#langToggle .flag-b');
      if(!a||!b) return;
      if(String(lang).toLowerCase().startsWith('de')){ a.src='/flags/de.svg'; b.src='/flags/at.svg'; }
      else { a.src='/flags/us.svg'; b.src='/flags/gb.svg'; }
    }
    function switchLang(to){
      const url=new URL(window.location.href);
      url.searchParams.set('lang',to);
      window.location.replace(url.toString()); // GET -> verhindert 405
    }
    document.addEventListener('DOMContentLoaded', function(){
      setSplit(document.documentElement.lang||'en');
      const btn=document.getElementById('langToggle');
      if(btn) btn.addEventListener('click', function(){ const to=nextLang(); setSplit(to); switchLang(to); });
    });
  })();

  // ===== HAMBURGER MENU (overlay) =====
  (function(){
    function openMenu(){
      const o=document.getElementById('menuOverlay'); if(!o) return;
      o.classList.remove('hidden');
      document.getElementById('menuButton')?.setAttribute('aria-expanded','true');
      setTimeout(()=>document.getElementById('themeLight')?.focus(), 0);
    }
    function closeMenu(){
      const o=document.getElementById('menuOverlay'); if(!o) return;
      o.classList.add('hidden');
      document.getElementById('menuButton')?.setAttribute('aria-expanded','false');
      document.getElementById('menuButton')?.focus();
    }
    document.addEventListener('DOMContentLoaded', function(){
      const mb=document.getElementById('menuButton');
      const mc=document.getElementById('menuClose');
      const ov=document.getElementById('menuOverlay');
      if(mb) mb.addEventListener('click', openMenu);
      if(mc) mc.addEventListener('click', closeMenu);
      if(ov) ov.addEventListener('click', (e)=>{ if(e.target.classList.contains('menu-backdrop')) closeMenu(); });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && !document.getElementById('menuOverlay')?.classList.contains('hidden')) closeMenu(); });
    });
  })();
</script>

<!-- Hamburger button (fixed) -->
<button id="menuButton" class="menu-button" aria-label="Open menu" aria-haspopup="dialog" aria-expanded="false" title="Menu">‚ò∞</button>

<!-- Overlay Menu -->
<div id="menuOverlay" class="menu-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="menuTitle">
  <div class="menu-backdrop"></div>
  <div class="menu-panel">
    <div class="menu-header">
      <h3 id="menuTitle" th:text="#{menu.title}">Settings</h3>
      <button id="menuClose" class="icon-btn" aria-label="Close">‚úï</button>
    </div>

    <div class="menu-section">
      <div class="menu-group">
        <div class="group-title" th:text="#{menu.theme}">Theme</div>
        <div class="menu-choice">
          <button id="themeLight" class="choice-btn" aria-pressed="false">
            <span class="mi-icon" aria-hidden="true">üåû</span><span th:text="#{theme.light}">Light</span>
          </button>
          <button id="themeDark" class="choice-btn" aria-pressed="false">
            <span class="mi-icon" aria-hidden="true">üåô</span><span th:text="#{theme.dark}">Dark</span>
          </button>
          <button id="themeSystem" class="choice-btn" aria-pressed="false">
            <span class="mi-icon" aria-hidden="true">üñ•Ô∏è</span><span th:text="#{theme.system}">System</span>
          </button>
        </div>
      </div>

      <button id="langToggle" class="menu-item">
        <span class="mi-icon flag-split" aria-hidden="true">
          <img class="flag flag-a" src="/flags/us.svg" alt="">
          <img class="flag flag-b" src="/flags/gb.svg" alt="">
        </span>
        <span class="mi-text" th:text="#{title.lang}">Switch language</span>
      </button>
    </div>
  </div>
</div>

<div class="container landing-container">
  <h1 th:text="#{ui.heading}">üÉè RBS' Estimation Poker</h1>

  <div th:if="${error != null or param.error != null}" class="error"
       th:text="${error != null ? error : param.error}">Fehlermeldung</div>

  <form th:action="@{/join}" method="post" id="joinForm" class="join-form">
    <div class="form-row">
      <div class="form-field">
        <label for="participantName" th:text="#{label.yourName}">Your name</label>
        <input type="text" id="participantName" name="participantName"
               th:value="${param.participantName != null ? param.participantName : participantName}">
      </div>

      <div class="form-field">
        <label for="roomCode" th:text="#{label.roomCode}">Room code / name</label>
        <div style="display:grid; gap:6px;">
          <input type="text" id="roomCode" name="roomCode"
                 th:value="${param.roomCode != null ? param.roomCode : roomCode}">
          <div id="nameCheck" class="hint" aria-live="polite"></div>
        </div>
      </div>
    </div>

    <!-- Persist UI only when feature enabled -->
    <div th:if="${@environment.getProperty('features.persistentRooms.enabled','false') == 'true'}">
      <div class="checkbox-row">
        <input type="checkbox" id="persistent" name="persistent"
               th:checked="${(param.persistent != null) or (persistent == true)}">
        <label for="persistent" th:text="#{label.persistRoom}">Persist this room</label>
      </div>
      <p class="hint" th:utext="#{hint.persistExpl}">
        Creates a deep link (<code>/room/{ID}</code>). The room persists until auto-cleanup.
      </p>

      <div id="testRoomWrap" class="checkbox-row hidden">
        <input type="checkbox" id="testRoom" name="testRoom"
               th:checked="${(param.testRoom != null) or (testRoom == true)}">
        <label for="testRoom" th:text="#{label.testRoom}">Test room only</label>
      </div>
      <p id="testRoomHint" class="hint hidden" th:text="#{hint.testRoom}">
        Marks as test ‚Äì will be cleaned up sooner.
      </p>
    </div>

    <!-- Hint when disabled -->
    <p class="hint"
       th:if="${@environment.getProperty('features.persistentRooms.enabled','false') != 'true'}">
      Persistent rooms are not available on this deployment.
    </p>

    <div class="form-actions">
      <button type="submit" class="button" th:text="#{button.join}">Join</button>
    </div>
  </form>
</div>

<!-- Join form JS -->
<script th:inline="javascript">
  (function () {
    const persistent = document.getElementById('persistent'); // may be null
    const testWrap   = document.getElementById('testRoomWrap'); // may be null
    const testHint   = document.getElementById('testRoomHint'); // may be null
    const testRoom   = document.getElementById('testRoom');     // may be null
    const roomCodeEl = document.getElementById('roomCode');
    const participantEl = document.getElementById('participantName');
    const nameCheck  = document.getElementById('nameCheck');
    const joinButton = document.querySelector('#joinForm button[type="submit"]');
    const joinForm   = document.getElementById('joinForm');

    let nameTaken = false;

    const MSG_CHECKING = /*[[#{status.checking}]]*/ 'Checking availability‚Ä¶';
    const MSG_FREE     = /*[[#{status.free}]]*/ '‚úÖ Name is available';
    const MSG_TAKEN    = /*[[#{status.taken}]]*/ '‚ùå Name is taken';

    function isEmpty(s){ return !s || s.trim().length===0; }
    function persistEnabled(){ return !!persistent; }
    function isPersistChecked(){ return persistent && persistent.checked; }

    function isSubmittable(){
      if (isEmpty(participantEl.value) || isEmpty(roomCodeEl.value)) return false;
      if (isPersistChecked() && nameTaken) return false;
      return true;
    }
    function updateSubmitEnabled(){ joinButton.disabled=!isSubmittable(); }

    function setStatusLoading(){ nameCheck.textContent=MSG_CHECKING; nameCheck.className="hint loading"; nameTaken=false; updateSubmitEnabled(); }
    function setStatusOK(){ nameCheck.textContent=MSG_FREE; nameCheck.className="hint ok"; nameTaken=false; updateSubmitEnabled(); }
    function setStatusBad(){ nameCheck.textContent=MSG_TAKEN; nameCheck.className="hint bad"; nameTaken=true; updateSubmitEnabled(); }
    function setStatusEmpty(){ nameCheck.textContent=""; nameCheck.className="hint"; nameTaken=false; updateSubmitEnabled(); }

    function syncTestVisibility(){
      if (!persistEnabled()) return;
      const show = isPersistChecked();
      if (testWrap) testWrap.classList.toggle('hidden', !show);
      if (testHint) testHint.classList.toggle('hidden', !show);
      if (!show && testRoom) testRoom.checked = false;
      if (!show) setStatusEmpty();
      updateSubmitEnabled();
    }

    // Debounce + Abort
    let debounceTimer=null, currentAbort=null;

    async function checkNameAvailability(name){
      if (!isPersistChecked()) { setStatusEmpty(); return; }
      const trimmed=(name||"").trim(); if (trimmed.length===0){ setStatusEmpty(); return; }

      if (currentAbort) currentAbort.abort();
      currentAbort=new AbortController(); const {signal}=currentAbort;

      setStatusLoading();
      try{
        const resp=await fetch(`/api/rooms/check?name=`+encodeURIComponent(trimmed),{signal});
        if(!resp.ok) throw new Error("Bad response: "+resp.status);
        const taken=await resp.json(); if(signal.aborted) return;
        if(taken===true) setStatusBad(); else setStatusOK();
      }catch(e){
        if (signal.aborted) return;
        setStatusEmpty();
        console.warn("Name check failed:", e);
      }
    }
    function scheduleCheck(){ clearTimeout(debounceTimer); debounceTimer=setTimeout(()=>checkNameAvailability(roomCodeEl.value),250); }

    joinForm.addEventListener('submit', function (event) {
      if (!isSubmittable()) { event.preventDefault(); joinButton.classList.add('shake'); setTimeout(()=>joinButton.classList.remove('shake'),400); }
    });

    // Init
    if (persistEnabled()) {
      syncTestVisibility();
      if (isPersistChecked()) scheduleCheck();
      persistent.addEventListener('change', ()=>{ syncTestVisibility(); if (isPersistChecked()) scheduleCheck(); else setStatusEmpty(); });
    }
    roomCodeEl.addEventListener('input', ()=>{ if (isPersistChecked()) scheduleCheck(); updateSubmitEnabled(); });
    participantEl.addEventListener('input', updateSubmitEnabled);
    updateSubmitEnabled();
  })();
</script>
</body>
</html>
