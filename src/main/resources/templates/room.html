<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:lang="${#locale}" lang="en">
<head th:replace="~{fragments/head :: head}"></head>
<body>

  <!-- App menu (fragment) -->
  <div th:replace="~{fragments/menu :: appMenu(showSeq=${true}, showAuto=${true}, showRoom=${true})}"></div>

  <div class="container">
    <h1 class="app-title">
      <img src="/favicon.svg" alt="" width="24" height="24" class="logo">
      <span th:text="#{ui.heading}" data-i18n="ui.heading">RBS' Estimation Poker</span>
    </h1>

    <dl class="main-info">
      <dt><span class="mi-icon" aria-hidden="true">👤</span><span class="mi-label" th:text="#{label.you}" data-i18n="label.you">You are:</span></dt>
      <dd><strong id="youName" th:text="${participantName}">Guest</strong></dd>

      <dt><span class="mi-icon" aria-hidden="true">🆔</span><span class="mi-label" th:text="#{label.room}" data-i18n="label.room">Room:</span></dt>
      <dd>
        <div class="room-with-actions">
          <strong id="roomCodeVal" th:text="${roomCode}">demo</strong>
          <button id="copyRoomLink"
                  class="icon-button"
                  type="button"
                  th:attr="aria-label=#{invite.copyLink},title=#{invite.copyLink}"
                  data-i18n-attr="aria-label:invite.copyLink;title:invite.copyLink"
                  aria-live="polite">🔗</button>
        </div>
      </dd>
    </dl>

    <h2 th:text="#{label.participants}" data-i18n="label.participants">Participants</h2>
    <ul id="liveParticipantList"></ul>

    <!-- Topic compact row (inline edit) -->
    <div id="topicRow" class="topic-row" data-test="topic-row" style="display:none;">
      <span class="topic-label" aria-hidden="true">📝</span>

      <!-- Display mode -->
      <span id="topicDisplay" class="topic-text" data-test="topic-display">–</span>

      <!-- Inline editor (hidden by default; JS toggles visibility) -->
      <form id="topicEditForm" class="hidden" onsubmit="return false">
        <input id="topicInput" data-test="topic-input" name="topic" type="text"
               th:attr="placeholder=#{topic.input.placeholder}" />
        <button id="topicSaveBtn" data-test="topic-save" type="button"
                th:text="#{button.saveTopic}">Save</button>
      </form>

      <!-- Affordances -->
      <div class="topic-actions">
        <button id="topicEditBtn" data-test="topic-edit" type="button"
                th:text="#{button.editTopic}"
                aria-label="Edit Topic">✏️</button>
        <button id="topicClearBtn" data-test="topic-clear" type="button"
                th:text="#{button.clearTopic}"
                aria-label="Clear Topic">Clear</button>
      </div>
    </div>

    <!-- Result row (reserved space; hidden until reveal) -->
    <p id="resultRow"
       class="average-label consensus-row result-row is-hidden"
       role="status" aria-live="polite" aria-atomic="true">

      <!-- Existing labels -->
      <span id="resultLabel" class="label">
        <span class="label-average" th:text="#{label.average}" data-i18n="label.average">Average:</span>
        <span class="label-consensus" hidden>🎉 Consensus</span>
      </span>

      <!-- Existing numeric slots -->
      <span id="averageVote" class="value">–</span>
      <span id="medianSep" class="sep" hidden aria-hidden="true"> • </span>
      <span id="medianWrap" class="stat" hidden>
        <span id="medianLabel" class="label" th:text="#{label.median}" data-i18n="label.median">Median:</span>
        <span id="medianVote" class="value">–</span>
      </span>
      <span id="rangeSep" class="sep" hidden aria-hidden="true"> • </span>
      <span id="rangeWrap" class="stat" hidden>
        <span id="rangeLabel" class="label" th:text="#{label.range}" data-i18n="label.range">Range:</span>
        <span id="rangeVote" class="value">–</span>
      </span>

      <!-- *** Added stable hooks for tests (non-breaking): avgRow/avgValue *** -->
      <span id="avgRow" style="display: inline;">
        <span id="avgValue" data-test="avg-value">–</span>
      </span>
      <!-- /hooks -->
    </p>

    <!-- Card grid (always visible; disabled after reveal via body class + JS) -->
    <div class="card-grid" id="cardGrid"></div>

    <!-- Actions (host): only buttons are toggled, container persists -->
    <div class="vote-actions">
      <button type="button" id="revealButton" class="button" hidden
              th:text="#{button.reveal}" data-i18n="button.reveal"
              th:attr="title=#{button.reveal},aria-label=#{button.reveal}"
              data-i18n-attr="title:button.reveal;aria-label:button.reveal"
              onclick="revealCards()"></button>

      <button type="button" id="resetButton" class="button" hidden
              th:text="#{button.reset}" data-i18n="button.reset"
              th:attr="title=#{button.reset},aria-label=#{button.reset}"
              data-i18n-attr="title:button.reset;aria-label:button.reset"
              onclick="resetRoom()"></button>
    </div>

    <div th:replace="~{fragments/kbase :: kbase}"></div>
    <th:block th:replace="~{fragments/kbase :: kbase-js}"></th:block>

  </div>

  <!-- Room connector (bump v-param if clients cache JS) -->
  <script defer th:src="@{/js/room.js?v=43}"
          th:attr="data-participant=${participantName},data-room=${roomCode}"></script>

  <div th:replace="~{fragments/footer :: footer}"></div>
</body>
</html>
