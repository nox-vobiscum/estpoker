<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="de">
<head>
    <meta charset="UTF-8">
    <title>Estimation Poker</title>
    <link rel="stylesheet" th:href="@{/styles.css}">
    <style>
        .selected {
            background-color: #4CAF50;
            color: white;
            font-weight: bold;
        }
    </style>
</head>
<body>

<script th:inline="javascript">
    let participantName = /*[[${participantName}]]*/ "Gast";

    const socket = new WebSocket("ws://localhost:8080/gameSocket");

    socket.onopen = function() {
        console.log("Verbindung zum Server hergestellt!");
    };

    socket.onmessage = function(event) {
        console.log("Nachricht vom Server: " + event.data);
    };

    socket.onerror = function(error) {
        console.log("WebSocket Fehler: " + error);
    };

    socket.onclose = function() {
        console.log("Verbindung zum Server geschlossen");
    };

    function sendVote(cardValue) {
        console.log("Kartenwert: " + cardValue);
        socket.send("vote:" + participantName + ":" + cardValue);

        // Hervorhebung der ausgewÃ¤hlten Karte
        const buttons = document.querySelectorAll(".card-grid button");
        buttons.forEach(btn => btn.classList.remove("selected"));
        const selected = Array.from(buttons).find(btn => btn.textContent === cardValue.toString());
        if (selected) {
            selected.classList.add("selected");
        }
    }
</script>

<div class="container">
    <h1>ğŸƒ Estimation Poker - Raum: <span th:text="${roomCode}"></span></h1>

    <!-- Teilnehmerinformationen -->
    <p>ğŸ‘¤ Du bist: <strong th:text="${participantName}"></strong></p>
    <p th:if="${isHost}">â­ Du bist der Host</p>
    <p th:if="${!isHost}">Host: <strong th:text="${hostName}"></strong></p>

    <!-- Teilnehmerliste -->
    <h2>Teilnehmer:</h2>
    <ul>
        <li th:each="p : ${participants}">
            <span th:text="${p.name}"></span>
        </li>
    </ul>

    <!-- Kartenabgabe -->
    <div th:if="${!votesRevealed}">
        <p><strong>Karte auswÃ¤hlen:</strong></p>
        <div class="card-grid">
            <button type="button"
                    th:each="cardValue : ${cards}"
                    th:text="${cardValue}"
                    th:attr="data-card=${cardValue}"
                    th:onclick="|sendVote(this.getAttribute('data-card'))|">
            </button>
        </div>

        <!-- Karten aufdecken (nur fÃ¼r Host) -->
        <form method="post" th:action="@{/reveal}" th:if="${isHost and not votesRevealed}">
            <input type="hidden" name="roomCode" th:value="${roomCode}"/>
            <input type="hidden" name="participantName" th:value="${participantName}"/>
            <button type="submit">ğŸŸ¡ Karten aufdecken</button>
        </form>
    </div>

    <!-- Ergebnisse (werden angezeigt, wenn die Karten aufgedeckt wurden) -->
    <div th:if="${votesRevealed}">
        <h2>Ergebnisse</h2>
        <ul>
            <li th:each="p : ${participantsWithVotes}">
                <span th:text="${p.name}"></span>:
                <strong th:text="${p.vote != null ? p.vote : 'â€”'}"></strong>
            </li>
        </ul>

        <p><strong>âŒ€ Durchschnitt (nur Zahlen):</strong>
            <span id="averageVote" th:text="${averageVote != null ? averageVote : 'N/A'}"></span>
        </p>

        <!-- Neue Runde starten (nur fÃ¼r Host) -->
        <form method="post" th:action="@{/reset}" th:if="${isHost}">
            <input type="hidden" name="roomCode" th:value="${roomCode}"/>
            <input type="hidden" name="participantName" th:value="${participantName}"/>
            <button type="submit">ğŸ”„ Neue Runde starten</button>
        </form>
    </div>
</div>
</body>
</html>
