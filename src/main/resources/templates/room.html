<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:lang="${#locale}" lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="dark light">
  <title th:text="#{app.title}">RBS' Estimation Poker</title>
  <link rel="icon" href="https://noxvobiscum.at/wp-content/uploads/2022/09/cropped-nvb-favicon-32x32.png" sizes="32x32" />
  <script>
    (function(){try{var t=localStorage.getItem('estpoker-theme')||'dark';
      if(t==='system')document.documentElement.removeAttribute('data-theme');
      else document.documentElement.setAttribute('data-theme',t);}catch(e){}})();
  </script>
  <link rel="stylesheet" th:href="@{/styles.css}">
</head>
<body>
<script th:inline="javascript">
  (function(){
    function currentTheme(){const a=document.documentElement.getAttribute('data-theme'); if(a) return a;
      try{ return matchMedia('(prefers-color-scheme: light)').matches?'light':'dark'; }catch(e){ return 'dark'; } }
    function setTheme(t){ if(t==='system')document.documentElement.removeAttribute('data-theme'); else document.documentElement.setAttribute('data-theme',t);
      try{localStorage.setItem('estpoker-theme',t);}catch(e){}; const b=document.getElementById('themeToggle'); if(b) b.textContent=(t==='light')?'🌞':'🌙'; }
    document.addEventListener('DOMContentLoaded', function(){
      const saved=localStorage.getItem('estpoker-theme')||'dark';
      const eff=(saved==='system')?currentTheme():saved;
      const b=document.getElementById('themeToggle'); if(b) b.textContent=(eff==='light')?'🌞':'🌙';
      if(b) b.addEventListener('click', ()=>setTheme(currentTheme()==='light'?'dark':'light'));
    });
  })();

  (function(){
    function nextLang(){const cur=(document.documentElement.lang||'en').toLowerCase();return cur.startsWith('de')?'en':'de';}
    function setSplit(lang){
      const a=document.querySelector('#langToggle .flag-a');
      const b=document.querySelector('#langToggle .flag-b');
      if(!a||!b) return;
      if(String(lang).toLowerCase().startsWith('de')){ a.src='/flags/de.svg'; b.src='/flags/at.svg'; }
      else { a.src='/flags/us.svg'; b.src='/flags/gb.svg'; }
    }
    function safeRoomUrlWithLang(lang){
      const url=new URL(window.location.href);
      url.searchParams.set('lang',lang);
      return url.toString();
    }
    document.addEventListener('DOMContentLoaded', function(){
      setSplit(document.documentElement.lang||'en');
      const btn=document.getElementById('langToggle');
      if(btn) btn.addEventListener('click', function(){
        const to=nextLang(); setSplit(to);
        window.location.replace(safeRoomUrlWithLang(to)); // GET -> vermeidet 405
      });
    });
  })();

  let participantName = /*[[${participantName}]]*/ "Guest";
  let roomCode = /*[[${roomCode}]]*/ "demo";
  let selectedCard = null;
  let votesRevealed = false;
  let isHost = false;
  let resizeTimer = null;

  const wsProtocol = location.protocol === "https:" ? "wss://" : "ws://";
  const socketUrl = wsProtocol + location.host + "/gameSocket?roomCode=" + roomCode + "&participantName=" + participantName;
  const socket = new WebSocket(socketUrl);

  socket.onopen = () => console.log("✅ Connected");

  const MSG_HOST_YOU   = /*[[#{toast.youAreHost}]]*/ 'Host {old} left. You are now host!';
  const MSG_HOST_OTHER = /*[[#{toast.hostOther}]]*/ 'Host {old} left. {new} is now host.';

  socket.onmessage = (event) => {
    const data = JSON.parse(event.data);

    if (data.type === "voteUpdate") {
      const prevVotesRevealed = votesRevealed;
      const participants = Array.isArray(data.participants) ? data.participants : [];

      votesRevealed = data.votesRevealed;
      isHost = participants.find(p => p.name === participantName)?.isHost === true;

      document.getElementById("revealButton").style.display = isHost && !votesRevealed ? "inline-block" : "none";
      document.getElementById("resetButton").style.display  = isHost && votesRevealed ? "inline-block" : "none";

      updateParticipantList(participants, votesRevealed);

      if (votesRevealed) { showResults(participants, data.averageVote); }
      else { toggleView(false); updateAverage(null); }

      if (prevVotesRevealed && !votesRevealed) { clearCardSelection(); }
      if (!votesRevealed && participants.every(p => p.vote == null)) { clearCardSelection(); }

      highlightSelectedCard();
    } else if (data.type === "hostChanged") {
      const { oldHost, newHost } = data;
      showToast(newHost === participantName
        ? MSG_HOST_YOU.replace('{old}', oldHost)
        : MSG_HOST_OTHER.replace('{old}', oldHost).replace('{new}', newHost)
      );
    }
  };

  function sendVote(cardValue) { socket.send("vote:" + participantName + ":" + cardValue); selectedCard = cardValue; highlightSelectedCard(); }
  function clearCardSelection(){ selectedCard = null; try { localStorage.removeItem('selectedCard'); } catch(e){} highlightSelectedCard(); }

  function highlightSelectedCard() {
    document.querySelectorAll(".card-grid button").forEach(btn => {
      const card = btn.getAttribute("data-card");
      const isSelected = !votesRevealed && card === selectedCard;
      btn.classList.toggle("selected", isSelected);
      const check = btn.querySelector(".checkmark");
      if (check) check.style.display = isSelected ? "block" : "none";
    });
  }

  function revealCards() { if (isHost) socket.send("revealCards"); }
  function resetRoom()   { if (isHost) socket.send("resetRoom"); clearCardSelection(); }

  function updateParticipantList(participants, revealed) {
    const list = document.getElementById("liveParticipantList");
    if (!list) return;
    list.innerHTML = "";

    participants.forEach(p => {
      const li = document.createElement("li");
      li.classList.add("participant-row");
      li.dataset.hasvote = p.vote !== null;

      if (p.disconnected) li.classList.add("disconnected");
      if (p.isHost) li.classList.add("is-host");

      const icon = document.createElement("span");
      icon.className = p.isHost
        ? "participant-icon host"
        : (p.disconnected ? "participant-icon inactive" : "participant-icon");
      icon.textContent = p.isHost ? "👑" : (p.disconnected ? "💤" : "👤");

      const nameSpan = document.createElement("span");
      nameSpan.className = "name";
      nameSpan.textContent = p.name;

      const rightWrap = document.createElement("div");
      rightWrap.className = "row-right";

      if (revealed) {
        const voteChip = document.createElement("span");
        voteChip.className = "vote-chip";
        const v = p.vote != null ? String(p.vote) : null;
        voteChip.textContent = v != null ? v : "—";
        if (v && !/^\d+$/.test(v)) voteChip.classList.add("special");
        rightWrap.appendChild(voteChip);
      } else {
        if (!p.disconnected && p.vote != null) {
          const status = document.createElement("span");
          status.className = "status-icon done";
          status.textContent = "✅";
          rightWrap.appendChild(status);
        } else if (!p.disconnected) {
          const status = document.createElement("span");
          status.className = "status-icon pending";
          status.textContent = "⏳";
          rightWrap.appendChild(status);
        }
      }

      li.appendChild(icon);
      li.appendChild(nameSpan);
      li.appendChild(rightWrap);
      list.appendChild(li);
    });

    measureAndSetNameColumn();
  }

  function measureAndSetNameColumn() {
    const list = document.getElementById("liveParticipantList");
    if (!list) return;
    const names = Array.from(list.querySelectorAll(".name"));
    const maxTextWidth = names.reduce((m, el) => Math.max(m, el.offsetWidth || 0), 0);
    list.style.setProperty("--name-text-col", Math.ceil(maxTextWidth) + "px");
  }

  window.addEventListener("resize", () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(measureAndSetNameColumn, 150);
  });

  function updateAverage(avg) {
    const avgSpan = document.getElementById("averageVote");
    if (avgSpan) avgSpan.textContent = avg != null ? avg : "N/A";
  }
  function toggleView(revealed) {
    document.querySelectorAll(".pre-vote").forEach(e => e.style.display = revealed ? "none" : "block");
    document.querySelectorAll(".post-vote").forEach(e => e.style.display = revealed ? "block" : "none");
  }
  function showResults(participants, avg) { toggleView(true); updateAverage(avg); }

  function showToast(message) {
    const toast = document.createElement("div");
    toast.className = "toast";
    document.body.appendChild(toast);
    toast.textContent = message;
    setTimeout(() => toast.remove(), 3000);
  }
</script>

<div class="container">
  <button id="themeToggle" class="theme-toggle" th:title="#{title.theme}" aria-label="Toggle light/dark mode">🌙</button>
  <button id="langToggle" class="lang-toggle" th:title="#{title.lang}" aria-label="Switch language">
    <span class="flag-split" aria-hidden="true">
      <img class="flag flag-a" src="/flags/us.svg" alt="" />
      <img class="flag flag-b" src="/flags/gb.svg" alt="" />
    </span>
    <span class="visually-hidden">Language</span>
  </button>

  <h1 th:text="#{ui.heading}">🃏 RBS' Estimation Poker</h1>

  <dl class="main-info">
    <dt><span class="mi-icon" aria-hidden="true">🆔</span><span class="mi-label" th:text="#{label.room}">Room:</span></dt>
    <dd><strong th:text="${roomCode}">demo</strong></dd>

    <dt><span class="mi-icon" aria-hidden="true">👤</span><span class="mi-label" th:text="#{label.you}">You are:</span></dt>
    <dd><strong th:text="${participantName}">Guest</strong></dd>
  </dl>

  <h2 th:text="#{label.participants}">Participants:</h2>
  <ul id="liveParticipantList"></ul>

  <h2 th:text="#{label.selectCard}">Choose a card:</h2>

  <div class="pre-vote">
    <div class="card-grid">
      <button type="button" th:each="cardValue : ${cardsRow1}"
              th:text="${cardValue}" th:attr="data-card=${cardValue}"
              th:onclick="|sendVote(this.getAttribute('data-card'))|">
        <span class="checkmark">✔</span>
      </button>
    </div>
    <div class="card-grid">
      <button type="button" th:each="cardValue : ${cardsRow2}"
              th:text="${cardValue}" th:attr="data-card=${cardValue}"
              th:onclick="|sendVote(this.getAttribute('data-card'))|">
        <span class="checkmark">✔</span>
      </button>
    </div>
    <div class="card-grid">
      <button type="button" th:each="cardValue : ${cardsRow3}"
              th:text="${cardValue}" th:attr="data-card=${cardValue}"
              th:onclick="|sendVote(this.getAttribute('data-card'))|">
        <span class="checkmark">✔</span>
      </button>
    </div>

    <button type="button" id="revealButton" class="button" style="display:none;"
            th:text="#{button.reveal}" onclick="revealCards()">Reveal cards</button>
  </div>

  <div class="post-vote" style="display:none;">
    <p class="average-label"><span th:text="#{label.average}">Average:</span> <span id="averageVote">–</span></p>
    <button type="button" id="resetButton" class="button" style="display:none;"
            th:text="#{button.reset}" onclick="resetRoom()">Start new round</button>
  </div>
</div>

<style>
.toast{ position:fixed; top:20px; right:20px; background:#333; color:#fff; padding:12px 20px; border-radius:8px; opacity:.9; z-index:9999; font-size:14px;
        animation: fadein .5s, fadeout .5s 2.5s; }
@keyframes fadein{ from{opacity:0; transform:translateY(-10px);} to{opacity:.9; transform:translateY(0);} }
@keyframes fadeout{ from{opacity:.9;} to{opacity:0;} }
</style>
</body>
</html>
