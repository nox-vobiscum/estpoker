<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="de">
<head>
    <meta charset="UTF-8">
    <title>RBS' Estimation Poker</title>
    <link rel="icon" href="https://noxvobiscum.at/wp-content/uploads/2022/09/cropped-nvb-favicon-32x32.png" sizes="32x32" />
    <link rel="stylesheet" th:href="@{/styles.css}">
</head>
<body>
<script th:inline="javascript">
    let participantName = /*[[${participantName}]]*/ "Gast";
    let roomCode = /*[[${roomCode}]]*/ "demo";
    let selectedCard = null;
    let votesRevealed = false;
    let isHost = false;

    const wsProtocol = location.protocol === "https:" ? "wss://" : "ws://";
    const socketUrl = wsProtocol + location.host + "/gameSocket?roomCode=" + roomCode + "&participantName=" + participantName;
    const socket = new WebSocket(socketUrl);

    socket.onopen = () => console.log("âœ… Verbindung zum Server hergestellt!");

    socket.onmessage = (event) => {
        const data = JSON.parse(event.data);
        console.log("ğŸ“¨ Nachricht empfangen:", data);

        if (data.type === "voteUpdate") {
            votesRevealed = data.votesRevealed;

            console.log("ğŸ§© Teilnehmerdaten:", data.participants);
            isHost = data.participants.find(p => p.name === participantName)?.isHost === true;
            console.log("ğŸ‘‘ Bin ich Host?", isHost);

            document.getElementById("revealButton").style.display = isHost && !votesRevealed ? "inline-block" : "none";
            document.getElementById("resetButton").style.display = isHost && votesRevealed ? "inline-block" : "none";

            updateParticipantList(data.participants, votesRevealed);

            if (votesRevealed) {
                showResults(data.participants, data.averageVote);
            } else {
                toggleView(false);
                updateAverage(null);
            }

            highlightSelectedCard();
        } else if (data.type === "hostChanged") {
            const oldHost = data.oldHost;
            const newHost = data.newHost;

            if (newHost === participantName) {
                showToast(`Host ${oldHost} hat den Raum verlassen. Du bist jetzt Host!`);
            } else {
                showToast(`Host ${oldHost} hat den Raum verlassen. ${newHost} ist jetzt Host.`);
            }
        }
    };

    function sendVote(cardValue) {
        socket.send("vote:" + participantName + ":" + cardValue);
        selectedCard = cardValue;
        highlightSelectedCard();
    }

    function highlightSelectedCard() {
        document.querySelectorAll(".card-grid button").forEach(btn => {
            const card = btn.getAttribute("data-card");
            const isSelected = !votesRevealed && card === selectedCard;
            btn.classList.toggle("selected", isSelected);
            const check = btn.querySelector(".checkmark");
            if (check) check.style.display = isSelected ? "block" : "none";
        });
    }

    function revealCards() {
        if (isHost) socket.send("revealCards");
    }

    function resetRoom() {
        if (isHost) socket.send("resetRoom");
        selectedCard = null;
        highlightSelectedCard();
    }

    function updateParticipantList(participants, revealed) {
        const list = document.getElementById("liveParticipantList");
        if (!list) return;
        list.innerHTML = "";

        participants.forEach(p => {
            const li = document.createElement("li");
            li.dataset.hasvote = p.vote !== null;
            if (p.disconnected) li.classList.add("disconnected");

            let nameDisplay = p.name;
            if (p.isHost) nameDisplay = `<span class="host-icon" title='Host'>ğŸ‘‘</span> ` + nameDisplay;
            let content = `<span class="name">${nameDisplay}</span>`;
            if (revealed) {
                const displayVote = p.vote != null ? `<strong>${p.vote}</strong>` : `<span>â€”</span>`;
                content += `: ${displayVote}`;
            }
            if (p.disconnected) {
                content += ` <span class="status">ğŸšª Verlassen</span>`;
            }

            li.innerHTML = content;
            list.appendChild(li);
        });
    }

    function updateAverage(avg) {
        const avgSpan = document.getElementById("averageVote");
        if (avgSpan) avgSpan.textContent = avg != null ? avg : "N/A";
    }

    function toggleView(revealed) {
        document.querySelectorAll(".pre-vote").forEach(e => e.style.display = revealed ? "none" : "block");
        document.querySelectorAll(".post-vote").forEach(e => e.style.display = revealed ? "block" : "none");
    }

    function showResults(participants, avg) {
        toggleView(true);
        updateAverage(avg);
    }

    function showToast(message) {
        const toast = document.createElement("div");
        toast.className = "toast";
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }
</script>

<div class="container">
    <h1>ğŸƒ RBS' Estimation Poker</h1>
    <div class="main-info">
        <p>ğŸ†” Raum: <strong th:text="${roomCode}">demo</strong></p>
        <p>ğŸ‘¤ Du bist: <strong th:text="${participantName}">Gast</strong></p>
    </div>
    
    <h2>Teilnehmende:</h2>
    <ul id="liveParticipantList"></ul>

    <div class="pre-vote">
        <p><strong>Karte auswÃ¤hlen:</strong></p>

        <div class="card-grid">
            <button type="button" th:each="cardValue : ${cardsRow1}"
                    th:text="${cardValue}"
                    th:attr="data-card=${cardValue}"
                    th:onclick="|sendVote(this.getAttribute('data-card'))|">
                <span class="checkmark">âœ”</span>
            </button>
        </div>
        <div class="card-grid">
            <button type="button" th:each="cardValue : ${cardsRow2}"
                    th:text="${cardValue}"
                    th:attr="data-card=${cardValue}"
                    th:onclick="|sendVote(this.getAttribute('data-card'))|">
                <span class="checkmark">âœ”</span>
            </button>
        </div>
        <div class="card-grid">
            <button type="button" th:each="cardValue : ${cardsRow3}"
                    th:text="${cardValue}"
                    th:attr="data-card=${cardValue}"
                    th:onclick="|sendVote(this.getAttribute('data-card'))|">
                <span class="checkmark">âœ”</span>
            </button>
        </div>

        <button type="button" id="revealButton" class="button" style="display: none;" onclick="revealCards()">ğŸŸ¡ Karten aufdecken</button>
    </div>

    <div class="post-vote" style="display: none;">
        <p class="average-label">âŒ€ Durchschnitt: <span id="averageVote">â€“</span></p>
        <button type="button" id="resetButton" class="button" style="display: none;" onclick="resetRoom()">ğŸ”„ Neue Runde starten</button>
    </div>
</div>

<style>
.toast {
    position: fixed;
    top: 20px;
    right: 20px;
    background-color: #333;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    opacity: 0.9;
    z-index: 9999;
    font-size: 14px;
    animation: fadein 0.5s, fadeout 0.5s 2.5s;
}
@keyframes fadein {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 0.9; transform: translateY(0); }
}
@keyframes fadeout {
    from { opacity: 0.9; }
    to { opacity: 0; }
}
</style>
</body>
</html>
